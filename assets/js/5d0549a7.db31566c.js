"use strict";(self.webpackChunkckb_sdk=self.webpackChunkckb_sdk||[]).push([[2498],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>m});var s=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,s)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,s,n=function(e,t){if(null==e)return{};var a,s,n={},r=Object.keys(e);for(s=0;s<r.length;s++)a=r[s],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(s=0;s<r.length;s++)a=r[s],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=s.createContext({}),c=function(e){var t=s.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=c(e.components);return s.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return s.createElement(s.Fragment,{},t)}},d=s.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),d=c(a),m=n,h=d["".concat(l,".").concat(m)]||d[m]||u[m]||r;return a?s.createElement(h,o(o({ref:t},p),{},{components:a})):s.createElement(h,o({ref:t},p))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,o=new Array(r);o[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:n,o[1]=i;for(var c=2;c<r;c++)o[c]=a[c];return s.createElement.apply(null,o)}return s.createElement.apply(null,a)}d.displayName="MDXCreateElement"},1566:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var s=a(7462),n=(a(7294),a(3905));a(4996);const r={id:"gasless-feature",title:"Gasless Feature"},o=void 0,i={unversionedId:"gasless-feature",id:"gasless-feature",title:"Gasless Feature",description:"Gas fees prevent new users from entering the Web3 world every day. This forces new users to acquire the native token (CKB or ETH) before participating in blockchain games or exchanging tokens on a DEX, which can be challenging. The gasless feature enables developers to sponsor transaction fees for users to ensure a smooth user experience.",source:"@site/docs/gaslessFeature.md",sourceDirName:".",slug:"/gasless-feature",permalink:"/gasless-feature",draft:!1,tags:[],version:"current",frontMatter:{id:"gasless-feature",title:"Gasless Feature"},sidebar:"sidebar2",previous:{title:"Account-Faucet",permalink:"/account-faucet"},next:{title:"How Godwoken experiments gasless transaction using simplified ERC-4337 proposal",permalink:"/gasless-with-ERC4337"}},l={},c=[{value:"Use cases",id:"use-cases",level:3},{value:"How to use gasless transactions for your dapp",id:"how-to-use-gasless-transactions-for-your-dapp",level:3},{value:"How to configure a paymaster contract",id:"how-to-configure-a-paymaster-contract",level:3},{value:"Project sample",id:"project-sample",level:3},{value:"More about paymaster",id:"more-about-paymaster",level:3}],p={toc:c};function u(e){let{components:t,...a}=e;return(0,n.kt)("wrapper",(0,s.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"Gas fees prevent new users from entering the Web3 world every day. This forces new users to acquire the native token (CKB or ETH) before participating in blockchain games or exchanging tokens on a DEX, which can be challenging. The gasless feature enables developers to sponsor transaction fees for users to ensure a smooth user experience."),(0,n.kt)("p",null,"The gas feature is based on a simpler version of the ",(0,n.kt)("a",{parentName:"p",href:"https://eips.ethereum.org/EIPS/eip-4337"},"ERC-4337 solution"),". To use such a feature, users sign and send a unique gasless transaction to call a specific smart contract named ",(0,n.kt)("inlineCode",{parentName:"p"},"Entrypoint"),", ",(0,n.kt)("inlineCode",{parentName:"p"},"Entrypoint")," will then call another smart contract named ",(0,n.kt)("inlineCode",{parentName:"p"},"Paymaster"),", which developers deploy to check if they are willing to pay the gas fee for this transaction. The unique gasless transaction must satisfy these requirements:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"tx.data")," must be the call data of calling ",(0,n.kt)("inlineCode",{parentName:"li"},"Entrypoint"),"'s ",(0,n.kt)("inlineCode",{parentName:"li"},"handleOp(UserOperation calldata op)")," function, which contains the target contract and the paymaster address."),(0,n.kt)("li",{parentName:"ul"},"Must set ",(0,n.kt)("inlineCode",{parentName:"li"},"tx.gasPrice")," to 0 (compatible with Metamask api)"),(0,n.kt)("li",{parentName:"ul"},"The ",(0,n.kt)("inlineCode",{parentName:"li"},"tx.to")," must be set to the ",(0,n.kt)("inlineCode",{parentName:"li"},"Entrypoint")," contract."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"tx.gas")," is equals to ",(0,n.kt)("inlineCode",{parentName:"li"},"op.callGasLimit + op.verificationGasLimit * 3"),".")),(0,n.kt)("p",null,"The gasless feature doesn't work with the native token transfer, which means the user still needs to pay the gas fee. And it doesn't allow users to pay the gas fee with ERC20 tokens either. The gasless feature only supports paying the gas fee with native tokens."),(0,n.kt)("h3",{id:"use-cases"},"Use cases"),(0,n.kt)("p",null,"Each solves some decentralized problem. With this gasless feature, some of these dapps can be improved with solutions like:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"DEX/Lending and rest transaction gas payments with project token (decreasing project inflation);"),(0,n.kt)("li",{parentName:"ul"},"NFT minting and exchange (to lower the entry threshold for crypto gaming);")),(0,n.kt)("h3",{id:"how-to-use-gasless-transactions-for-your-dapp"},"How to use gasless transactions for your dapp"),(0,n.kt)("p",null,"Let's say we have the entrypoint contract ",(0,n.kt)("inlineCode",{parentName:"p"},"ENTRYPOINT_CONTRACT_ADDRESS"),", and as a game developer, we want to pay the gas fees for some whitelist users, so we'll write a paymaster contract just like ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/godwokenrises/account-abstraction/blob/gw-gasless/contracts/samples/GaslessDemoPaymaster.sol"},"this one")," as ",(0,n.kt)("inlineCode",{parentName:"p"},"PAYMASTER_CONTRACT_ADDRESS"),"."),(0,n.kt)("p",null,"dapp frontend using ethers.js"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-ts"},'      // define UserOp\n      const userOperation: UserOperationStruct = {\n          callContract: realGameContract.address,\n          callData: realGameContractCallData,\n          callGasLimit: gasToExecuteRealGameContractCallData,\n          verificationGasLimit: gasToVerifyPaymaster,\n          maxFeePerGas: gasPrice,\n          maxPriorityFeePerGas: gasPrice,\n          paymasterAndData: PAYMASTER_CONTRACT_ADDRESS \n      }\n      \n      // 1. construct and send gasless transaction via native sendTransaction\n      const abiCoder = new ethers.utils.AbiCoder();\n      const userOp = abiCoder.encode(["tuple(address callContract, bytes callData, uint256 callGasLimit, uint256 verificationGasLimit, uint256 maxFeePerGas, uint256 maxPriorityFeePerGas, bytes paymasterAndData) UserOperation"], [userOperation]);\n      // first 4 bytes of keccak hash of handleOp((address,bytes,uint256,uint256,uint256,uint256,bytes))\n      const fnSelector = "fb4350d8";\n      // gasless payload = ENTRYPOINT_HANDLE_OP_SELECTOR + abiEncode(UserOperation)\n      const payload = "0x" + fnSelector + userOp.slice(2);\n      const gaslessTx = {\n        from: whitelistUser.address,\n        to: ENTRYPOINT_CONTRACT_ADDRESS,\n        data: payload,\n        gasPrice: 0,\n        gasLimit: 1000000,\n        value: 0,\n      }\n      const signer = new ethers.Wallet("private key");\n      const tx = await signer.sendTransaction(gaslessTx);\n      await tx.wait();\n      // 2. or just use ethers contract factory with EntryFactory and call it directly\n      {\n        // Send tx with a valid user.\n        const EntryPoint = await ethers.getContractFactory("EntryPoint");\n        const entrypoint = await EntryPoint.attach(ENTRYPOINT_CONTRACT_ADDRESS);\n        const tx = await entryPoint.connect(whitelistUser).handleOp(userOp, {gasLimit: 100000, gasPrice: 0});\n        await tx.wait();\n      }\n')),(0,n.kt)("h3",{id:"how-to-configure-a-paymaster-contract"},"How to configure a paymaster contract"),(0,n.kt)("p",null,"From the previous example we have deployed a contract like ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/godwokenrises/account-abstraction/blob/gw-gasless/contracts/samples/GaslessDemoPaymaster.sol"},"this one"),". However, this contract should be configurable to work through the web3 API. To do this, please execute the following smart contract methods:\nYou can find more detail in the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/godwokenrises/account-abstraction/blob/gw-gasless/test/gasless_paymaster.test.ts#L45"},"unit test"),". In this test, we deploy a DummyContract as our dapp. Then we can send some gasless trasactions to interface with the DummyContract."),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"The developer should execute ",(0,n.kt)("inlineCode",{parentName:"li"},"addStake")," ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/godwokenrises/account-abstraction/blob/541f7cac9d83e75d152e7a58bec6d97b51221012/contracts/core/GaslessBasePaymaster.sol#L85"},"method")," to register your ",(0,n.kt)("inlineCode",{parentName:"li"},"paymaster")," on the ",(0,n.kt)("inlineCode",{parentName:"li"},"entrypoint"),". This will add ",(0,n.kt)("inlineCode",{parentName:"li"},"paymaster")," contract allowance to perform as a ",(0,n.kt)("inlineCode",{parentName:"li"},"gasless provider")," for your project. "),(0,n.kt)("li",{parentName:"ol"},"The developer should deposit some balance to the paymaster through entrypoint. You can execute ",(0,n.kt)("inlineCode",{parentName:"li"},"deposit")," ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/godwokenrises/account-abstraction/blob/541f7cac9d83e75d152e7a58bec6d97b51221012/contracts/core/GaslessBasePaymaster.sol#L68"},"method")," on ",(0,n.kt)("inlineCode",{parentName:"li"},"paymaster")," to add a balance. Or, you can execute ",(0,n.kt)("inlineCode",{parentName:"li"},"entrypoint.depositTo(address paymaster)")," with a balance directly. This is required as all gasless tx costs will be covered by the balance on the ",(0,n.kt)("inlineCode",{parentName:"li"},"paymaster")," contract."),(0,n.kt)("li",{parentName:"ol"},"We can put an account to the whitelist by executing ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/godwokenrises/account-abstraction/blob/541f7cac9d/contracts/core/GaslessBasePaymaster.sol#L127"},"addWhitelistAddress"),". So now, only users from the whitelist can send gasless transactions."),(0,n.kt)("li",{parentName:"ol"},"Just putting a user in the whitelist is dangerous. We need to make sure the user can only send transactions to our dapp(which is DummyContract in this sample). So we need another ",(0,n.kt)("inlineCode",{parentName:"li"},"whitelist")," of contract addresses. We can execute ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/godwokenrises/account-abstraction/blob/541f7cac9d/contracts/core/GaslessBasePaymaster.sol#L140"},"addAvailAddr")," to put DummyContract into the whitelist. You can find that our demo paymaster will check the contract address ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/godwokenrises/account-abstraction/blob/541f7cac9d/contracts/samples/GaslessDemoPaymaster.sol#L32"},"here"),"."),(0,n.kt)("li",{parentName:"ol"},"Attention, please set the same values to ",(0,n.kt)("inlineCode",{parentName:"li"},"maxFeePerGas")," and ",(0,n.kt)("inlineCode",{parentName:"li"},"maxPriorityFeePerGas")," in UserOperation. Otherwise, ",(0,n.kt)("inlineCode",{parentName:"li"},"block.basefee")," which is introduced in ",(0,n.kt)("a",{parentName:"li",href:"https://eips.ethereum.org/EIPS/eip-3198"},"EIP-3198")," since London hard fork, will be used to calculate the gas price. For now, godwoken doesn't support London hard fork yet, so you will see a weird error if you give them different values.")),(0,n.kt)("p",null,"All setup! Now the user can send gasless transactions to DummyContract."),(0,n.kt)("h3",{id:"project-sample"},"Project sample"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://gasless-nft-ui.pages.dev/"},"https://gasless-nft-ui.pages.dev/")," - first test the NFT minting dapp in a gasless way with payment in test tokens"),(0,n.kt)("p",null,"Example of codebase: ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/BuildClub/gassless-nft-minter"},"https://github.com/BuildClub/gassless-nft-minter")),(0,n.kt)("p",null,"Test project token for payment - ",(0,n.kt)("a",{parentName:"p",href:"https://gw-explorer.nervosdao.community/address/0xced7c0c6DE215c995Cf08D464f6a2132b2FAD37D"},"0xced7c0c6DE215c995Cf08D464f6a2132b2FAD37D")),(0,n.kt)("p",null,"Paymaster address - ",(0,n.kt)("a",{parentName:"p",href:"https://gw-explorer.nervosdao.community/address/0x2078cf0E3535A48f8e28a36b2fCFcEC429162F60"},"0x2078cf0E3535A48f8e28a36b2fCFcEC429162F60")),(0,n.kt)("p",null,"Entrypoint address - ",(0,n.kt)("a",{parentName:"p",href:"https://gw-explorer.nervosdao.community/address/0x791ec459f57362256f313f5512bdb9f6d7cae308"},"0x791ec459f57362256f313f5512bdb9f6d7cae308")),(0,n.kt)("p",null,"NFT address - ",(0,n.kt)("a",{parentName:"p",href:"https://gw-explorer.nervosdao.community/address/0x9bFAA0A71390061DF1F69D2640808a015653D84b"},"0x9bFAA0A71390061DF1F69D2640808a015653D84b")),(0,n.kt)("p",null,"Here is another demo with less code: ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/sunchengzhu/godwoken-gasless-example"},"godwoken gasless example")),(0,n.kt)("h3",{id:"more-about-paymaster"},"More about paymaster"),(0,n.kt)("p",null,"In this document, we give a demo about how to use a whitelist paymaster. Another great example, and a more practical one, is ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/godwokenrises/account-abstraction/blob/gw-gasless/contracts/samples/TokenPaymaster.sol"},"TokenPaymaster"),". Compare with a whitelist, you can see that it's more convenient to manage users who can send gasless transactions with ERC20 tokens."),(0,n.kt)("p",null,"You may find something more interesting behind the idea of godwoken gasless feature in here: ",(0,n.kt)("a",{parentName:"p",href:"gasless-with-ERC4337"},"How Godwoken experiments gasless transaction using simplified ERC-4337 proposal"),"."))}u.isMDXComponent=!0}}]);